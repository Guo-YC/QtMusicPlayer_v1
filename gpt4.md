# Qt HTTP音乐播放器详细项目报告

[TOC]

## 0、视频展示


<iframe height=345 width=470  src="src/QtMusuicPlay3.mp4">

视频文件路径：`src/QtMusicPlay4.mp4`


## 一、项目概述

### 1.1 项目简介

- Qt HTTP音乐播放器是一款基于Qt框架开发的跨平台桌面音乐播放器。该播放器集成了本地音乐播放和在线音乐播放功能，用户可以方便地导入本地音乐文件或添加在线音乐资源进行播放


### 1.2 项目目标

- 基本需求:
- [x] 支持 MP3 格式音乐播放
- [x] 支持基本的播放控制功能，如播放、暂停、上一曲、下一曲
- [x] 支持在线音乐播放，通过 HTTP 请求获取音乐资源
- [x] 支持歌词自动匹配并显示
- [x] 支持专辑图片自动匹配并显示
- [x] 支持音量调节、静音功能。
- [x] 支持播放进度显示,时间显示
- [x] 支持歌曲切换
- 扩展需求:
- [x] 支持拖动进度条调整进度
- [x] 支持专辑图片动画,在播放时可同步旋转
- [x] 支持本地音乐缓存与播放
- [ ] 支持 MP3 以外的格式播放,如WAV、FLAC、AAC等
- [x] 支持播放模式选择，如顺序播放、单曲循环、随机播放等
- [ ] 支持最小化托盘
- [ ] 其他可扩展功能

### 1.3 项目范围

项目主要聚焦于开发桌面端的音乐播放器，支持的音乐格式初期为MP3，计划后续添加对WAV、FLAC等格式的支持。播放器支持自动获取在线歌单列表信息，并能够根据用户选择播放在线音乐。此外，播放器还具备基本的播放控制功能，如播放、暂停、上一曲、下一曲等。

## 二、系统架构与设计

### 2.1 架构概述

Qt HTTP音乐播放器采用了MVC（模型-视图-控制器）架构模式，以分离用户界面与业务逻辑，提高应用的可维护性和扩展性。系统架构主要分为以下几个部分：
- **视图层（View）**：用户界面，负责展示数据和接收用户操作。
- **控制层（Controller）**：处理用户输入，通过模型层处理数据，然后更新视图层。
- **模型层（Model）**：数据访问层，包括音乐播放控制和网络数据交互。

### 2.2 模块划分

系统主要模块包括：
- **播放器控制模块（KMediaPlayerManager）**：封装了所有音乐播放控制逻辑，包括加载文件、播放、暂停、音乐播放控制等。
- **音乐资源管理模块（KSongTableModel）**：管理音乐库，支持添加、删除歌曲和创建播放列表。
- **网络通信模块（KxHttpRequestManager）**：负责执行所有网络请求，如下载歌曲、获取歌词和搜索在线资源。
- **用户界面模块（KMainWindow）**：为用户提供操作界面，包括播放控制按钮、音乐列表和播放信息显示。
- **线程处理模块（KThreadTask）**：提供多线程处理功能，包括获取歌曲音乐资源等。

### 2.3 技术选型

选用Qt框架是因为其跨平台特性以及丰富的网络和多媒体处理功能。其中使用QNetworkAccessManager类进行网络请求，QMediaPlayer类进行音乐播放和音量控制，QMediaPlaylist类管理播放列表，QThread实现多线程处理。

## 三、功能实现

### 3.1 基本播放功能

项目支持基本的音乐播放功能，用户可以通过图形界面对音乐进行播放、暂停、停止、跳到下一曲或上一曲。通过集成Qt的QMediaPlayer类，我们能够轻松实现对音频文件的控制，并通过QMediaPlaylist管理播放列表。

- 技术实现：主要通过监听QPushButton::clicked信号，在槽函数中对KMediaPlayermanager类进行进行对应操作，在KMediaPlayermanager内部，封装了QQMediaPlayer和QMediaPlaylist的各个接口操作，实现对应的操作效果。


### 3.2 在线音乐支持

通过实现KxHttpRequestManager模块，应用能够处理复杂的HTTP请求，支持用户在线搜索音乐和播放在线音乐流。此模块还负责处理音乐文件和歌词的下载任务。

- 技术实现：通过信号与槽函数，实现KxHttpRequestManager和KSongTableModel类数据通信。将http请求数据返回给调用类并保存。

### 3.3 高级功能实现

#### 进度条调整
使用QSlider控件实现音乐播放的进度条，用户可以通过拖动进度条快速定位到音乐的任何位置。

- 技术实现：KMediaPlayermanager内部通过监听歌曲QMediaPlayer::positionChanged，发出KMediaPlayerManager::onPositionChanged信号，KMainWindow内部接受该信号，再槽函数计算进度条目标值，更新ui的进度条。

#### 专辑图片动画
在音乐播放时，专辑封面图片会进行旋转动画，增加视觉效果，提高用户体验，歌曲暂停时停止旋转。

- 技术实现：通过监听进度条歌曲QMediaPlayer::positionChanged信号，每接受一次信号，则对专辑图片进行固定角度的旋转。

#### 本地音乐缓存
项目支持将在线获取的音乐缓存到本地硬盘，用户可以在没有网络连接的情况下播放之前已下载的音乐。

- 技术实现：当播放音乐时，首先判断当前是否已经存在缓存文件，如果没有，则获取在线音乐资源，并保存至本地中，更新资源路径。


### 3.4 用户交互设计 

界面右侧为获取的在线歌曲列表

![](src/image.PNG)

## 四、技术细节

### 4.1 类图分析

详细分析了KMainWindow、KMediaPlayerManager、KSongTableModel等关键类的职责和相互关系，强调了如何通过分层的设计模式降低各模块之间的耦合度。

![UML类图](src\UML_class.PNG)

文件路径：`src/UML_class.PNG`


### 4.2 时序图分析

通过时序图，展示了从用户发起播放命令到音乐输出的完整流程，包括用户界面如何与后端逻辑交互，以及网络模块如何响应音乐播放请求。

![UML时序图](src\UML_Time.PNG)

文件路径：`src\UML_Time.PNG`

## 五、项目挑战与收获

### 5.1 遇到的主要挑战

- 资源请求下载速度慢：通过创建KxThreadTask类，将http请求任务放入线程中处理。
- 槽函数无法接受到对应信号：原因为槽函数参数类型格式不完全匹配，导致无法和信号一一对应。
- http响应处理槽函数接受数据为空：原因为一个信号触发多个槽函数时，党第一个槽函数处理完后传入参数地址已被销毁。

- 歌词解析和显示问题：歌词文件由于为一个长的字符串，首先需要对字符进行拆分为多个子串。然后使用正则表达式，解析其中的时间点，歌曲播放时，根据不同的歌曲进度，匹配对应的歌词进行展示。

### 5.2 项目收获

- 加深对信号与槽函数机制的理解。
- 加深对MVD架构的理解，将不懂的职责划分给不同的类。
- 通过对每个功能模块的划分，对应负责类提供响应的独立接口。

### 5.3 未来展望

- 实现窗口最小化效果
- 优化http请求响应接受效率和体验
- 实现本地音乐播放
- 实现多类型文件播放